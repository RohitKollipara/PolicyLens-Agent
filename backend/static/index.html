<!DOCTYPE html>
<html class="light" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>

<!-- Favicon -->
<link rel="icon" href="policy lens.png" type="image/x-icon">
<link rel="icon" type="image/png" sizes="32x32" href="policy lens.png">
<link rel="icon" type="image/png" sizes="16x16" href="policy lens.png">
<link rel="apple-touch-icon" sizes="180x180" href="policy lens.png">

<title>PolicyLens - Intelligent Analysis</title>

<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&amp;display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap" rel="stylesheet"/>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<script id="tailwind-config">
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#4285F4",
                    "g-red": "#EA4335",
                    "g-yellow": "#FBBC05",
                    "g-green": "#34A853",
                    "background-light": "#ffffff",
                    "background-dark": "#202124",
                    "surface-light": "#f8f9fa",
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"]
                },
                borderRadius: {"DEFAULT": "0.5rem", "lg": "1rem", "xl": "1.5rem", "2xl": "2rem", "3xl": "2.5rem", "full": "9999px"},
            },
        },
    }
</script>
</head>
<body class="font-display bg-background-light dark:bg-background-dark text-[#202124] dark:text-white overflow-x-hidden transition-colors duration-300">
<div class="fixed inset-0 -z-10 h-full w-full overflow-hidden pointer-events-none">
<div class="absolute -top-[10%] -left-[10%] h-[50vh] w-[50vh] rounded-full bg-primary/20 blur-[120px] dark:bg-primary/10"></div>
<div class="absolute top-[10%] right-[10%] h-[40vh] w-[40vh] rounded-full bg-g-red/15 blur-[100px] dark:bg-g-red/10"></div>
<div class="absolute bottom-[20%] left-[10%] h-[40vh] w-[40vh] rounded-full bg-g-yellow/15 blur-[100px] dark:bg-g-yellow/10"></div>
<div class="absolute -bottom-[10%] right-[20%] h-[50vh] w-[50vh] rounded-full bg-g-green/15 blur-[120px] dark:bg-g-green/10"></div>
</div>
<div class="relative flex min-h-screen flex-col">
<header class="w-full px-6 py-5 lg:px-12 sticky top-0 z-50 backdrop-blur-md bg-white/80 dark:bg-[#202124]/80 border-b border-gray-100 dark:border-white/10">
<div class="mx-auto flex max-w-7xl items-center justify-between">
<div class="flex items-center gap-2.5">
<div class="flex h-10 w-10 items-center justify-center rounded-xl text-white shadow-sm">
    <img src="policy lens.png" alt="PolicyLens" class="h-10 w-10">
</div>
<h2 class="text-2xl font-bold tracking-tight text-[#202124] dark:text-white">
<span>PolicyLens</span>
</h2>
</div>
<div class="flex items-center gap-4">
<button id="darkModeToggle" class="p-2 rounded-lg hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors" title="Toggle dark mode">
    <span class="material-symbols-outlined text-gray-600 dark:text-gray-300">dark_mode</span>
</button>
</div>
</header>
<main class="flex flex-1 flex-col items-center justify-center px-4 py-8 lg:px-8">
<div class="relative w-full max-w-4xl">
<div class="relative overflow-hidden rounded-3xl border border-white/60 bg-white/60 shadow-[0_8px_32px_0_rgba(66,133,244,0.05)] backdrop-blur-xl dark:border-white/10 dark:bg-[#202124]/60 dark:shadow-none p-8 md:p-12">
<div class="absolute top-0 right-0 -mt-10 -mr-10 h-32 w-32 rounded-full bg-gradient-to-br from-g-red/20 to-g-yellow/20 blur-2xl"></div>
<div class="absolute bottom-0 left-0 -mb-10 -ml-10 h-32 w-32 rounded-full bg-gradient-to-tr from-primary/20 to-g-green/20 blur-2xl"></div>
<div class="relative z-10 flex flex-col items-center text-center">

<h1 class="mb-4 max-w-3xl text-3xl font-black tracking-tighter text-[#202124] dark:text-white sm:text-4xl md:text-5xl lg:leading-tight">
Intelligent 
<span class="bg-clip-text text-transparent bg-gradient-to-r from-g-red/80 via-g-yellow/80 via-primary/60 via-g-green/80 to-primary/60 dark:from-red-300 dark:via-yellow-300 dark:via-blue-300 dark:via-green-300 dark:to-blue-300 font-bold text-3xl sm:text-4xl md:text-5xl lg:leading-tight">
PolicyLens
</span>
Insights
</h1>
<p class="mb-8 max-w-xl text-base text-gray-600 dark:text-gray-300 font-medium leading-relaxed">
Transform raw policy documents into actionable insights in seconds. Securely upload your datasets below to start processing.
</p>

<!-- File Upload Section -->
<div class="flex w-full flex-col gap-4 sm:flex-row sm:justify-center mb-6">
<!-- Policy PDF Upload -->
<div class="relative flex-1 sm:max-w-[280px]">
<button 
onclick="document.getElementById('policyPdfInput').click()"
id="policyPdfBtn"
class="group relative flex h-auto min-h-[140px] w-full flex-col items-center justify-center gap-3 rounded-2xl border-2 border-gray-100 bg-white p-5 text-[#202124] shadow-lg transition-all hover:-translate-y-1 hover:bg-primary hover:text-white hover:border-primary hover:shadow-xl dark:border-white/10 dark:bg-[#303134] dark:text-white dark:hover:bg-primary dark:hover:border-primary">
<div class="rounded-full bg-gray-50 p-3 text-gray-600 transition-transform group-hover:scale-110 group-hover:bg-white/20 group-hover:text-white dark:bg-gray-700 dark:text-gray-300">
<span class="material-symbols-outlined text-2xl">description</span>
</div>
<div class="flex flex-col gap-1">
<span class="text-base font-bold">Upload Policy PDF</span>
<span class="text-xs font-medium text-gray-500 dark:text-gray-400 group-hover:text-white/90 transition-colors">.pdf format</span>
</div>
</button>
<input type="file" id="policyPdfInput" accept=".pdf" class="hidden"/>
<div id="policyFilePreview" class="hidden mt-3 p-3 rounded-xl bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800">
<div class="flex items-center justify-between">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-blue-600 dark:text-blue-400 text-sm">description</span>
<span id="policyFileName" class="text-sm font-medium text-blue-900 dark:text-blue-100"></span>
</div>
<button onclick="clearPolicyFile()" class="text-blue-600 dark:text-blue-400 hover:text-blue-800 transition-colors">
<span class="material-symbols-outlined text-sm">close</span>
</button>
</div>
</div>
</div>

<!-- Demographic Data Upload -->
<div class="relative flex-1 sm:max-w-[280px]">
<button 
onclick="document.getElementById('demographicInput').click()"
id="demographicBtn"
class="group relative flex h-auto min-h-[140px] w-full flex-col items-center justify-center gap-3 rounded-2xl border-2 border-gray-100 bg-white p-5 text-[#202124] shadow-lg transition-all hover:-translate-y-1 hover:bg-g-green hover:text-white hover:border-g-green hover:shadow-xl dark:border-white/10 dark:bg-[#303134] dark:text-white dark:hover:bg-g-green dark:hover:border-g-green">
<div class="rounded-full bg-gray-50 p-3 text-gray-600 transition-transform group-hover:scale-110 group-hover:bg-white/20 group-hover:text-white dark:bg-gray-700 dark:text-gray-300">
<span class="material-symbols-outlined text-2xl">table_view</span>
</div>
<div class="flex flex-col gap-1">
<span class="text-base font-bold">Upload Demographic Data</span>
<span class="text-xs font-medium text-gray-500 dark:text-gray-400 group-hover:text-white/90 transition-colors">.csv, .xlsx formats</span>
</div>
</button>
<input type="file" id="demographicInput" accept=".csv,.xlsx" class="hidden"/>
<div id="demographicFilePreview" class="hidden mt-3 p-3 rounded-xl bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800">
<div class="flex items-center justify-between">
<div class="flex items-center gap-2">
<span class="material-symbols-outlined text-green-600 dark:text-green-400 text-sm">table_view</span>
<span id="demographicFileName" class="text-sm font-medium text-green-900 dark:text-green-100"></span>
</div>
<button onclick="clearDemographicFile()" class="text-green-600 dark:text-green-400 hover:text-green-800 transition-colors">
<span class="material-symbols-outlined text-sm">close</span>
</button>
</div>
</div>
</div>
</div>

<!-- Analyze Button -->
<div class="mt-6 flex justify-center">
<button
id="analyzeBtn"
class="group relative inline-flex items-center gap-3 rounded-full
bg-primary px-10 py-4
text-base font-bold text-white
shadow-lg shadow-blue-500/30
transition-all duration-300
hover:-translate-y-0.5 hover:bg-blue-600 hover:shadow-blue-500/50
focus:outline-none focus:ring-4 focus:ring-primary/30
disabled:cursor-not-allowed disabled:opacity-50 disabled:hover:translate-y-0"
disabled
>
<span class="material-symbols-outlined text-xl transition-transform group-hover:scale-110">auto_graph</span>
<span id="analyzeBtnText">Analyse</span>
</button>
</div>

<!-- Error Message -->
<div id="errorMessage" class="hidden mt-4 p-4 rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 max-w-md">
<p class="text-red-800 dark:text-red-200 font-medium text-sm text-center"></p>
</div>

</div>
</div>
</div>
</main>
<footer class="w-full py-6 text-center border-t border-gray-100 dark:border-white/5 mt-auto bg-surface-light dark:bg-[#202124]">
<p class="text-sm font-medium text-gray-500 dark:text-gray-400"></p>
</footer>
</div>

<script>
let policyFile = null;
let demographicFile = null;

const policyPdfInput = document.getElementById('policyPdfInput');
const demographicInput = document.getElementById('demographicInput');
const analyzeBtn = document.getElementById('analyzeBtn');
const analyzeBtnText = document.getElementById('analyzeBtnText');
const errorMessage = document.getElementById('errorMessage');
const policyFilePreview = document.getElementById('policyFilePreview');
const demographicFilePreview = document.getElementById('demographicFilePreview');
const policyFileName = document.getElementById('policyFileName');
const demographicFileName = document.getElementById('demographicFileName');

const MAX_FILE_SIZE = 10 * 1024 * 1024; // 10MB

function showError(message) {
    errorMessage.querySelector('p').textContent = message;
    errorMessage.classList.remove('hidden');
    setTimeout(() => errorMessage.classList.add('hidden'), 5000);
}

function updateAnalyzeButton() {
    if (policyFile) {
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('opacity-50', 'cursor-not-allowed');
    } else {
        analyzeBtn.disabled = true;
        analyzeBtn.classList.add('opacity-50', 'cursor-not-allowed');
    }
}

function clearPolicyFile() {
    policyFile = null;
    policyPdfInput.value = '';
    policyFilePreview.classList.add('hidden');
    updateAnalyzeButton();
}

function clearDemographicFile() {
    demographicFile = null;
    demographicInput.value = '';
    demographicFilePreview.classList.add('hidden');
}

// Policy PDF handler
policyPdfInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > MAX_FILE_SIZE) {
        showError(`File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds maximum allowed size (10MB)`);
        this.value = '';
        return;
    }
    
    if (!file.name.toLowerCase().endsWith('.pdf')) {
        showError('Invalid file type. Please upload a PDF file.');
        this.value = '';
        return;
    }
    
    policyFile = file;
    policyFileName.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
    policyFilePreview.classList.remove('hidden');
    updateAnalyzeButton();
});

// Demographic file handler
demographicInput.addEventListener('change', function(e) {
    const file = e.target.files[0];
    if (!file) return;
    
    if (file.size > MAX_FILE_SIZE) {
        showError(`File size (${(file.size / (1024 * 1024)).toFixed(2)}MB) exceeds maximum allowed size (10MB)`);
        this.value = '';
        return;
    }
    
    const validExtensions = ['.csv', '.xlsx'];
    const fileName = file.name.toLowerCase();
    if (!validExtensions.some(ext => fileName.endsWith(ext))) {
        showError('Invalid file type. Please upload a CSV or XLSX file.');
        this.value = '';
        return;
    }
    
    demographicFile = file;
    demographicFileName.textContent = `${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
    demographicFilePreview.classList.remove('hidden');
});

// Analyze button handler
analyzeBtn.addEventListener('click', async function() {
    if (!policyFile) {
        showError('Please upload a policy PDF file first.');
        return;
    }
    
    // Show loading state
    analyzeBtn.disabled = true;
    analyzeBtnText.textContent = 'Analyzing...';
    analyzeBtn.innerHTML = `
        <span class="material-symbols-outlined text-xl animate-spin">sync</span>
        <span>Analyzing...</span>
    `;
    errorMessage.classList.add('hidden');
    
    try {
        const formData = new FormData();
        formData.append('policy_file', policyFile);
        if (demographicFile) {
            formData.append('demographic_file', demographicFile);
        }
        
        const response = await fetch('/api/analyze', {
            method: 'POST',
            body: formData
        });
        
        let data;
        try {
            data = await response.json();
        } catch (parseError) {
            throw new Error('Invalid response from server. Please try again.');
        }
        
        if (!response.ok) {
            if (response.status === 400) {
                throw new Error(data.detail || 'Invalid request. Please check your files and try again.');
            } else if (response.status === 413) {
                throw new Error('File size too large. Maximum file size is 10MB.');
            } else if (response.status === 429) {
                throw new Error('Rate limit exceeded. Please wait a moment and try again.');
            } else if (response.status === 504) {
                throw new Error('Request timed out. The document may be too large. Please try with a smaller document.');
            } else if (response.status >= 500) {
                throw new Error('Server error. Please try again later.');
            } else {
                throw new Error(data.detail || data.error || 'Analysis failed');
            }
        }
        
        // Store results and redirect
        try {
            const jsonData = JSON.stringify(data);
            console.log("Storing results, size:", jsonData.length);
            sessionStorage.setItem('analysisResults', jsonData);
            
            // Small delay to ensure storage is complete
            setTimeout(() => {
                window.location.href = 'results.html';
            }, 100);
        } catch (storageError) {
            console.error("Error storing results:", storageError);
            showError("Error saving results. Please try again.");
            analyzeBtn.disabled = false;
            analyzeBtn.innerHTML = `
                <span class="material-symbols-outlined text-xl transition-transform group-hover:scale-110">auto_graph</span>
                <span>Analyse</span>
            `;
            updateAnalyzeButton();
        }
        
    } catch (error) {
        console.error('Error:', error);
        let errorMsg = error.message || 'An error occurred while analyzing the policy.';
        if (error.name === 'TypeError' && error.message.includes('fetch')) {
            errorMsg = 'Network error. Please check your connection and try again.';
        }
        showError(errorMsg);
        
        // Reset button
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = `
            <span class="material-symbols-outlined text-xl transition-transform group-hover:scale-110">auto_graph</span>
            <span>Analyse</span>
        `;
        updateAnalyzeButton();
    }
});

// Dark mode toggle
function initDarkMode() {
    const isDark = localStorage.getItem('darkMode') === 'true' || 
                   (!localStorage.getItem('darkMode') && window.matchMedia('(prefers-color-scheme: dark)').matches);
    
    if (isDark) {
        document.documentElement.classList.add('dark');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) {
            toggle.querySelector('span').textContent = 'light_mode';
        }
    } else {
        document.documentElement.classList.remove('dark');
        const toggle = document.getElementById('darkModeToggle');
        if (toggle) {
            toggle.querySelector('span').textContent = 'dark_mode';
        }
    }
}

const darkModeToggle = document.getElementById('darkModeToggle');
if (darkModeToggle) {
    darkModeToggle.addEventListener('click', () => {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('darkMode', isDark);
        darkModeToggle.querySelector('span').textContent = isDark ? 'light_mode' : 'dark_mode';
    });
}

// Initialize dark mode
initDarkMode();

// Initialize
updateAnalyzeButton();
</script>

</body>
</html>
